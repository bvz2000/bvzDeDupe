#! /usr/bin/env python3
"""
NOTE: This code is SUPER SUPER TEMP. Just to test out the modules. Once those are working, this code will be refactored
into a proper front end.
"""

import os
import sys
import displaylib

from session import Session

helpmsg = f"""
A program to compare all of the files in a query directory to the files in a
canonical directory and list any which are duplicates. The query directory is
the directory where you may have a bunch of files that may or may not already
exist in another location (the canonical location where they are supposed to
reside). Using this program you can decide whether you need to copy the files
from the query directory to the canonical location, or whether these files
already exist in the canonical directory and may therefore be deleted from the
query directory. Note: This program DOES NOT actually touch any files on disk.
It merely reports on duplicates.

You may decide which characteristics are considered when deciding whether two
files are duplicates of each other or not.

The possible characteristics are listed below. If you do not indicate any
characteristics using the options provided, then the only thing that is considered
is whether the contents of the files are identical, regardless of the file name,
date, or location in the directory structure.

Usage: {os.path.split(sys.argv[0])[1]} <query directory> <canonical directory> <-n -p -t -r -c -m -h>

-n    The names of the files must match in order for the files to be considered 
      duplicates.
-p    The names of the parent directories of the files must match in order for 
      the files to be considered duplicates.
-t    The file types (extensions) of the files must match in order for the files 
      to be considered duplicates.
-r    The relative paths of the files must match in order for the files to be 
      considered duplicates.
-c    The creation date and time of the files must match in order for the files 
      to be considered duplicates.
-m    The modification date and time of the files must match in order for the 
      files to be considered duplicates.
-h    Show this help string and exit.

Note: Each option must have its own hyphen (dash). For example, You may not do this: -nptrcm. 
      You must do this: -n -p -t -r -c -m.
"""

if "-h" in sys.argv:
    displaylib.display_message(helpmsg)
    sys.exit(1)

if len(sys.argv) < 3:
    displaylib.display_message(f"{{RED}}Missing required arguments")
    displaylib.display_message(helpmsg)
    sys.exit(1)

if len(sys.argv) > 3:
    for item in sys.argv[3:]:
        if item not in ["-n", "-p", "-t", "-r", "-c", "-m"]:
            displaylib.display_message(f"{{RED}}Unknown option: {item}")
            displaylib.display_message(helpmsg)
            sys.exit(2)

query_path = sys.argv[1]
canonical_path = sys.argv[2]

if not os.path.exists(query_path) or not os.path.isdir(query_path):
    displaylib.display_message(f"{{RED}}Query path ({query_path}) either does not exist or is not a directory.")
    sys.exit(3)

if not os.path.exists(canonical_path) or not os.path.isdir(canonical_path):
    displaylib.display_message(f"{{RED}}Canonical path ({canonical_path}) either does not exist or is not a directory.")
    sys.exit(3)

if "-n" in sys.argv:
    name=True
else:
    name = False

if "-p" in sys.argv:
    parent = True
else:
    parent = False

if "-t" in sys.argv:
    file_type = True
else:
    file_type = False

if "-r" in sys.argv:
    rel_path = True
else:
    rel_path = False

if "-c" in sys.argv:
    ctime = True
else:
    ctime = False

if "-m" in sys.argv:
    mtime = True
else:
    mtime = False

session_obj = Session(query_dir=query_path,
                      canonical_dir=canonical_path,
                      report_frequency=10)

# ----------------------------------------------------------------------------------------------------------------------
displaylib.display_message("\n\n{{BRIGHT_GREEN}}QUERY DIRECTORY")
displaylib.display_message("="*80)
try:
    for counter in session_obj.do_query_scan():
        displaylib.display_refreshable_message(f"Files scanned so far: {counter}")
except IOError as e:
    displaylib.display_message(f"{{BRIGHT_RED}}ERROR:{{COLOR_NONE}} {str(e)}")
    sys.exit(1)
displaylib.display_refreshable_message(" "*80)
displaylib.finish_refreshable_message()

displaylib.display_message(f"Number of files scanned: {{BRIGHT_RED}}{session_obj.query_scan.checked_count}")
displaylib.display_message(f"Number of error files: {{BRIGHT_RED}}{session_obj.query_scan.error_count}")
displaylib.display_message(f"Number of links skipped: {{BRIGHT_RED}}{session_obj.query_scan.skipped_links}")
displaylib.display_message(f"Number of zero length files skipped: {{BRIGHT_RED}}{session_obj.query_scan.skipped_zero_len}")
displaylib.display_message(f"Number of hidden files skipped: {{BRIGHT_RED}}{session_obj.query_scan.skipped_hidden}")
displaylib.display_message(f"Number of files skipped because they were outside of the inclusion regex's: {{BRIGHT_RED}}{session_obj.query_scan.skipped_include}")
displaylib.display_message(f"Number of files skipped because they matched the exclusion regex's: {{BRIGHT_RED}}{session_obj.query_scan.skipped_exclude}")
displaylib.display_message(f"Number of files accumulated: {{BRIGHT_RED}}{session_obj.query_scan.initial_count}")

# ----------------------------------------------------------------------------------------------------------------------
displaylib.display_message("\n\n{{BRIGHT_GREEN}}CANONICAL DIRECTORY")
displaylib.display_message("="*80)
try:
    for counter in session_obj.do_canonical_scan():
        displaylib.display_refreshable_message(f"Files scanned so far: {counter}")
except IOError as e:
    displaylib.display_message(f"{{BRIGHT_RED}}ERROR:{{COLOR_NONE}} {str(e)}")
    sys.exit(1)
displaylib.display_refreshable_message(" "*80)
displaylib.finish_refreshable_message()

displaylib.display_message(f"Number of files scanned: {{BRIGHT_RED}}{session_obj.canonical_scan.checked_count}")
displaylib.display_message(f"Number of error files: {{BRIGHT_RED}}{session_obj.canonical_scan.error_count}")
displaylib.display_message(f"Number of links skipped: {{BRIGHT_RED}}{session_obj.canonical_scan.skipped_links}")
displaylib.display_message(f"Number of zero length files skipped: {{BRIGHT_RED}}{session_obj.canonical_scan.skipped_zero_len}")
displaylib.display_message(f"Number of hidden files skipped: {{BRIGHT_RED}}{session_obj.canonical_scan.skipped_hidden}")
displaylib.display_message(f"Number of files skipped because they were outside of the inclusion regex's: {{BRIGHT_RED}}{session_obj.canonical_scan.skipped_include}")
displaylib.display_message(f"Number of files skipped because they matched the exclusion regex's: {{BRIGHT_RED}}{session_obj.canonical_scan.skipped_exclude}")
displaylib.display_message(f"Number of files accumulated: {{BRIGHT_RED}}{session_obj.canonical_scan.initial_count}")

# ----------------------------------------------------------------------------------------------------------------------
displaylib.display_message("\n\n{{BRIGHT_YELLOW}}COMPARING FILES:")
displaylib.display_message("="*80)

old_percent = 0
for count in session_obj.do_compare(name=name,
                                    file_type=file_type,
                                    parent=parent,
                                    rel_path=rel_path,
                                    ctime=ctime,
                                    mtime=mtime):
    old_percent = displaylib.display_progress(count=count,
                                              total=len(session_obj.query_scan.files),
                                              old_percent=old_percent)
displaylib.display_message("\n")

# ----------------------------------------------------------------------------------------------------------------------
displaylib.display_message("\n\n{{BRIGHT_GREEN}}RESULTS:")
displaylib.display_message("="*80)

displaylib.display_message(f"Number of files checked: {{BRIGHT_RED}}{len(session_obj.query_scan.files)}")
displaylib.display_message(f"Number of duplicate files: {{BRIGHT_RED}}{len(session_obj.actual_matches)}")
displaylib.display_message(f"Number of times a checksum was reused: {{BRIGHT_RED}}{session_obj.pre_computed_checksum_count}")

result = ""
displaylib.display_message("\n\n")
while result.lower() not in {"yes", "y", "no", "n"}:
    result = input("Do you want to display the matching files? (Y/N)")
    if result.lower() in {"no", "n"}:
        sys.exit(0)

# ----------------------------------------------------------------------------------------------------------------------
displaylib.display_message("\n\n{{BRIGHT_GREEN}}MATCHES")
displaylib.display_message("="*80)

for file_path, matches in session_obj.actual_matches.items():
    displaylib.display_message(file_path)
    for match in matches:
        displaylib.display_message(f"{{BRIGHT_CYAN}}{match}")
    displaylib.display_message("\n\n")
